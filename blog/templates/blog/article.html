{% extends 'blog/base_blog.html' %}

{% block title %}乌鸦的庭院:{{ article.title }}{% endblock %}

{% block path_nav %}
  <nav class="light-blue lighten-2 hide-on-large-only">
    <div class="nav-wrapper" style="padding-left: 10px;">
      <a href="{% url 'homepage:index' %}" class="breadcrumb">Home</a>
      <a href="{% url 'blog:index' %}" class="breadcrumb">Blog</a>
      <a href="{% url 'blog:category' article.category.url_name %}"
         class="breadcrumb">{{ article.category.category_name }}</a>
    </div>
  </nav>
{% endblock %}

{% block main_area %}
  <section>
    <div class="card light-blue">
      <div class="card-content white-text">
        <div class="card-title"><h4>{{ article.title }}</h4></div>
        <br>
        {% if tags_list %}
          {% for tag in tags_list %}
            <span class="chip">{{ tag.tag_name }}</span>
          {% endfor %}
        {% endif %}
        <p class="right-align">{{ article.publish_time | date:"Y-m-d" }}</p>
      </div>
    </div>
  </section>
  <article class="card-panel white">
    {% load blog_filter %}
    {{ article.text|markdown2html }}
    {% if user.is_authenticated %}
      <p class="right-align">
        <small>
          <a href="{% url 'crows:article_edit' article_type='article' article_id=article.id %}">编辑
          </a></small>
      </p>
    {% endif %}
  </article>
  {% block comment_display %}
    <div class="card-panel white">
      {% if comments_list %}
        <p>阅读{{ article.clicks }} 评论{{ comments_list.count }}</p>
        <ul class="collection">
          {% for comment in comments_list %}
            {% if forloop.last %}
              <a name="lastcmt"></a>
            {% endif %}
            <li class="collection-item">
              <a href="#post" class="title"
                 id="{{ comment.floor }}">#{{ comment.floor }} {{ comment.name }}</a>
              <small>{{ comment.timestamp | date:"Y-m-d H:i:s" }}</small>
              <p>{{ comment.content|markdown2html }}</p>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>阅读:{{ article.clicks }} 评论:0</p>
        <p>目前尚未有评论，欢迎发表意见</p>
      {% endif %}
    </div>
  {% endblock %}

  {% block comment_form %}
    <div class="card-panel">
      <form class="form-horizontal" id="post-form" action="{% url 'blog:comment' article.id %}" method="post">
        {% csrf_token %}
        <a name="post"></a>
        {% if post_comment_form.errors %}
          <div class="alert alert-error">
            <ul>
              {% for error in post_comment_form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        <div class="form-group">
          {{ post_comment_form.name.errors }}
          <label class="col-md-1 control-label" style="text-align: right"
                 for="{{ post_comment_form.name.id_for_label }}">
            {{ post_comment_form.name.label }}</label>
          <div class="col-md-5">
            {{ post_comment_form.name }}
          </div>
        </div>
        <div class="form-group">
          {{ post_comment_form.email.errors }}
          <label class="col-md-1 control-label" style="text-align: right"
                 for="{{ post_comment_form.email.id_for_label }}">
            {{ post_comment_form.email.label }}</label>
          <div class="col-md-5">
            {{ post_comment_form.email }}
          </div>
        </div>
        <div class="form-group">
          {{ post_comment_form.content.errors }}
          <label class="col-md-1 control-label" style="text-align: right"
                 for="{{ post_comment_form.content.id_for_label }}">
            {{ post_comment_form.content.label }}</label>
          <div class="col-md-10">
            {{ post_comment_form.content }}
          </div>
        </div>
        <div class="form-group {% if field.errors %}has-error{% endif %}">
          {{ post_comment_form.captcha.errors }}
          <label class="control-label" for="{{ post_comment_form.captcha.id_for_label }}"
                 style="padding: 15px">
            {{ post_comment_form.captcha.label }}
          </label>
          {{ post_comment_form.captcha }}
          <button class="btn btn-default btn-raised btn-submit"
                  id="post_comment" type="submit" style="margin: 15px;">提交
          </button>
        </div>
      </form>
    </div>
  {% endblock %}
{% endblock %}

{% block footer %}
  <p class="text-center">结夜野棠的个人博客</p>
{% endblock %}

{% block addition %}
  <script type="text/javascript" charset="utf-8">

    this_url = window.location.href;
    if (this_url.indexOf("article") == -1) {
      self.location.href = "#post";
    }

    $(".comment").click(function () {
      var cmtId = $(this).attr('id');
      var msg = document.getElementById(cmtId).innerHTML;
      var text = document.getElementById("content");
      text.value = "    回复 " + msg + " 的评论\n";
      var formAction = "{% url 'blog:comment' article.id %}" + cmtId + '/';
      $('#post-form').attr('action', formAction);
      self.location.href = "#post";
    });

  </script>
{% endblock %}